<?php
session_start();
require_once __DIR__ . '/userAccounts/config.php';

// Admin guard
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'admin') {
  header('Location: /pages/loginPage.php');
  exit;
}

$user_id = $_SESSION['user_id'];

// CSRF token
if (empty($_SESSION['csrf_token'])) {
  $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}
$csrf = $_SESSION['csrf_token'];

function flash($type, $msg) {
  $_SESSION['flash'] = ['type' => $type, 'msg' => $msg];
}

// Handle POST actions
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  $token = $_POST['csrf_token'] ?? '';
  if (!hash_equals($_SESSION['csrf_token'], $token)) {
    flash('danger', 'Invalid CSRF token.');
    header('Location: /manage-locations.php');
    exit;
  }

  $action = $_POST['action'] ?? '';
  
  // MUNICIPALITY ACTIONS
  if ($action === 'add_municipality') {
    $name = trim($_POST['name'] ?? '');
    $province = trim($_POST['province'] ?? 'Cebu');

    if ($name === '') {
      flash('danger', 'Municipality name is required.');
    } else {
      $stmt = $conn->prepare('INSERT INTO municipalities (name, province) VALUES (?, ?)');
      $stmt->bind_param('ss', $name, $province);
      if ($stmt->execute()) {
        flash('success', 'Municipality added successfully.');
      } else {
        flash('danger', 'Failed to add municipality: ' . $conn->error);
      }
      $stmt->close();
    }
    header('Location: /manage-locations.php');
    exit;
  }

  if ($action === 'edit_municipality') {
    $id = (int)($_POST['id'] ?? 0);
    $name = trim($_POST['name'] ?? '');
    $province = trim($_POST['province'] ?? 'Cebu');

    if ($id <= 0 || $name === '') {
      flash('danger', 'Invalid data.');
    } else {
      $stmt = $conn->prepare('UPDATE municipalities SET name=?, province=? WHERE id=?');
      $stmt->bind_param('ssi', $name, $province, $id);
      if ($stmt->execute()) {
        flash('success', 'Municipality updated successfully.');
      } else {
        flash('danger', 'Failed to update municipality: ' . $conn->error);
      }
      $stmt->close();
    }
    header('Location: /manage-locations.php');
    exit;
  }

  if ($action === 'delete_municipality') {
    $id = (int)($_POST['id'] ?? 0);
    if ($id <= 0) {
      flash('danger', 'Invalid municipality ID.');
    } else {
      // Check if municipality has barangays
      $check = $conn->prepare('SELECT COUNT(*) as count FROM barangays WHERE municipality_id=?');
      $check->bind_param('i', $id);
      $check->execute();
      $result = $check->get_result()->fetch_assoc();
      $check->close();
      
      if ($result['count'] > 0) {
        flash('warning', 'Cannot delete municipality with existing barangays. Delete barangays first.');
      } else {
        $stmt = $conn->prepare('DELETE FROM municipalities WHERE id=?');
        $stmt->bind_param('i', $id);
        if ($stmt->execute()) {
          flash('success', 'Municipality deleted successfully.');
        } else {
          flash('danger', 'Failed to delete municipality: ' . $conn->error);
        }
        $stmt->close();
      }
    }
    header('Location: /manage-locations.php');
    exit;
  }

  // BARANGAY ACTIONS
  if ($action === 'add_barangay') {
    $name = trim($_POST['name'] ?? '');
    $municipality_id = (int)($_POST['municipality_id'] ?? 0);

    if ($name === '' || $municipality_id <= 0) {
      flash('danger', 'Barangay name and municipality are required.');
    } else {
      $stmt = $conn->prepare('INSERT INTO barangays (name, municipality_id) VALUES (?, ?)');
      $stmt->bind_param('si', $name, $municipality_id);
      if ($stmt->execute()) {
        flash('success', 'Barangay added successfully.');
      } else {
        flash('danger', 'Failed to add barangay: ' . $conn->error);
      }
      $stmt->close();
    }
    header('Location: /manage-locations.php');
    exit;
  }

  if ($action === 'edit_barangay') {
    $id = (int)($_POST['id'] ?? 0);
    $name = trim($_POST['name'] ?? '');
    $municipality_id = (int)($_POST['municipality_id'] ?? 0);

    if ($id <= 0 || $name === '' || $municipality_id <= 0) {
      flash('danger', 'Invalid data.');
    } else {
      $stmt = $conn->prepare('UPDATE barangays SET name=?, municipality_id=? WHERE id=?');
      $stmt->bind_param('sii', $name, $municipality_id, $id);
      if ($stmt->execute()) {
        flash('success', 'Barangay updated successfully.');
      } else {
        flash('danger', 'Failed to update barangay: ' . $conn->error);
      }
      $stmt->close();
    }
    header('Location: /manage-locations.php');
    exit;
  }

  if ($action === 'delete_barangay') {
    $id = (int)($_POST['id'] ?? 0);
    if ($id <= 0) {
      flash('danger', 'Invalid barangay ID.');
    } else {
      // Check if barangay has users
      $check = $conn->prepare('SELECT COUNT(*) as count FROM users WHERE barangay_id=?');
      $check->bind_param('i', $id);
      $check->execute();
      $result = $check->get_result()->fetch_assoc();
      $check->close();
      
      if ($result['count'] > 0) {
        flash('warning', 'Cannot delete barangay with registered users. Reassign users first.');
      } else {
        $stmt = $conn->prepare('DELETE FROM barangays WHERE id=?');
        $stmt->bind_param('i', $id);
        if ($stmt->execute()) {
          flash('success', 'Barangay deleted successfully.');
        } else {
          flash('danger', 'Failed to delete barangay: ' . $conn->error);
        }
        $stmt->close();
      }
    }
    header('Location: /manage-locations.php');
    exit;
  }
}

// Fetch municipalities with barangay count
$municipalities = $conn->query("
  SELECT m.*, 
         (SELECT COUNT(*) FROM barangays WHERE municipality_id = m.id) as barangay_count,
         (SELECT COUNT(*) FROM users WHERE municipality_id = m.id) as user_count
  FROM municipalities m 
  ORDER BY m.name ASC
");

// Fetch barangays with municipality info
$barangays = $conn->query("
  SELECT b.*, m.name as municipality_name,
         (SELECT COUNT(*) FROM users WHERE barangay_id = b.id) as user_count
  FROM barangays b
  JOIN municipalities m ON b.municipality_id = m.id
  ORDER BY m.name ASC, b.name ASC
");

// Get all municipalities for dropdowns
$municipalities_for_select = $conn->query("SELECT id, name FROM municipalities ORDER BY name ASC");
$municipalities_list = [];
while ($m = $municipalities_for_select->fetch_assoc()) {
  $municipalities_list[] = $m;
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Locations - CommServe</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <style>
    body { background-color: #f8f9fa; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="/dashboards/adminDashboard.php">
        <i class="bi bi-geo-alt-fill me-2"></i>Manage Locations
      </a>
      <div class="d-flex">
        <a class="nav-link text-white" href="/dashboards/adminDashboard.php">
          <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
        </a>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <?php if (!empty($_SESSION['flash'])): ?>
      <div class="alert alert-<?= htmlspecialchars($_SESSION['flash']['type']) ?> alert-dismissible fade show">
        <?= htmlspecialchars($_SESSION['flash']['msg']) ?>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      <?php unset($_SESSION['flash']); ?>
    <?php endif; ?>

    <!-- Municipalities Section -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-building me-2"></i>Municipalities / Cities</h5>
        <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addMunicipalityModal">
          <i class="bi bi-plus-circle me-1"></i>Add Municipality
        </button>
      </div>
      <div class="card-body">
        <!-- Search Filter -->
        <div class="mb-3">
          <input type="text" id="municipalitySearch" class="form-control" placeholder="Search municipalities...">
        </div>
        <?php if ($municipalities && $municipalities->num_rows > 0): ?>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Municipality/City</th>
                  <th>Province</th>
                  <th>Barangays</th>
                  <th>Users</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <?php while ($mun = $municipalities->fetch_assoc()): ?>
                  <tr>
                    <td><?= $mun['id'] ?></td>
                    <td><strong><?= htmlspecialchars($mun['name']) ?></strong></td>
                    <td><?= htmlspecialchars($mun['province']) ?></td>
                    <td><span class="badge bg-info"><?= $mun['barangay_count'] ?></span></td>
                    <td><span class="badge bg-secondary"><?= $mun['user_count'] ?></span></td>
                    <td>
                      <button class="btn btn-sm btn-primary" onclick="editMunicipality(<?= $mun['id'] ?>, '<?= htmlspecialchars($mun['name'], ENT_QUOTES) ?>', '<?= htmlspecialchars($mun['province'], ENT_QUOTES) ?>')">
                        <i class="bi bi-pencil"></i> Edit
                      </button>
                      <button class="btn btn-sm btn-danger" onclick="deleteMunicipality(<?= $mun['id'] ?>, '<?= htmlspecialchars($mun['name'], ENT_QUOTES) ?>')">
                        <i class="bi bi-trash"></i> Delete
                      </button>
                    </td>
                  </tr>
                <?php endwhile; ?>
              </tbody>
            </table>
          </div>
          <div id="municipalityNoResults" class="text-muted text-center d-none">No municipalities found.</div>
        <?php else: ?>
          <p class="text-muted text-center">No municipalities found.</p>
        <?php endif; ?>
      </div>
    </div>

    <!-- Barangays Section -->
    <div class="card shadow-sm">
      <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-geo-fill me-2"></i>Barangays</h5>
        <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addBarangayModal">
          <i class="bi bi-plus-circle me-1"></i>Add Barangay
        </button>
      </div>
      <div class="card-body">
        <!-- Filter Section -->
        <div class="row mb-3">
          <div class="col-md-6">
            <input type="text" id="barangaySearch" class="form-control" placeholder="Search barangays...">
          </div>
          <div class="col-md-6">
            <select id="municipalityFilter" class="form-select">
              <option value="">All Municipalities</option>
              <?php foreach ($municipalities_list as $m): ?>
                <option value="<?= htmlspecialchars($m['name']) ?>"><?= htmlspecialchars($m['name']) ?></option>
              <?php endforeach; ?>
            </select>
          </div>
        </div>
        <?php if ($barangays && $barangays->num_rows > 0): ?>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Barangay</th>
                  <th>Municipality/City</th>
                  <th>Users</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="barangayTableBody">
                <?php while ($brgy = $barangays->fetch_assoc()): ?>
                  <tr data-barangay="<?= htmlspecialchars($brgy['name']) ?>" data-municipality="<?= htmlspecialchars($brgy['municipality_name']) ?>">
                    <td><?= $brgy['id'] ?></td>
                    <td><strong><?= htmlspecialchars($brgy['name']) ?></strong></td>
                    <td><?= htmlspecialchars($brgy['municipality_name']) ?></td>
                    <td><span class="badge bg-secondary"><?= $brgy['user_count'] ?></span></td>
                    <td>
                      <button class="btn btn-sm btn-primary" onclick="editBarangay(<?= $brgy['id'] ?>, '<?= htmlspecialchars($brgy['name'], ENT_QUOTES) ?>', <?= $brgy['municipality_id'] ?>)">
                        <i class="bi bi-pencil"></i> Edit
                      </button>
                      <button class="btn btn-sm btn-danger" onclick="deleteBarangay(<?= $brgy['id'] ?>, '<?= htmlspecialchars($brgy['name'], ENT_QUOTES) ?>')">
                        <i class="bi bi-trash"></i> Delete
                      </button>
                    </td>
                  </tr>
                <?php endwhile; ?>
              </tbody>
            </table>
          </div>
          <div id="barangayNoResults" class="text-muted text-center d-none">No barangays found.</div>
        <?php else: ?>
          <p class="text-muted text-center">No barangays found.</p>
        <?php endif; ?>
      </div>
    </div>
  </div>

  <!-- Add Municipality Modal -->
  <div class="modal fade" id="addMunicipalityModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-building me-2"></i>Add Municipality/City</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" action="/manage-locations.php">
          <div class="modal-body">
            <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrf) ?>">
            <input type="hidden" name="action" value="add_municipality">
            <div class="mb-3">
              <label class="form-label">Municipality/City Name</label>
              <input type="text" name="name" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Province</label>
              <input type="text" name="province" class="form-control" value="Cebu" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-dark">Add Municipality</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Municipality Modal -->
  <div class="modal fade" id="editMunicipalityModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-building me-2"></i>Edit Municipality/City</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" action="/manage-locations.php">
          <div class="modal-body">
            <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrf) ?>">
            <input type="hidden" name="action" value="edit_municipality">
            <input type="hidden" name="id" id="editMunicipalityId">
            <div class="mb-3">
              <label class="form-label">Municipality/City Name</label>
              <input type="text" name="name" id="editMunicipalityName" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Province</label>
              <input type="text" name="province" id="editMunicipalityProvince" class="form-control" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-dark">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Barangay Modal -->
  <div class="modal fade" id="addBarangayModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-geo-fill me-2"></i>Add Barangay</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" action="/manage-locations.php">
          <div class="modal-body">
            <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrf) ?>">
            <input type="hidden" name="action" value="add_barangay">
            <div class="mb-3">
              <label class="form-label">Barangay Name</label>
              <input type="text" name="name" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Municipality/City</label>
              <select name="municipality_id" class="form-select" required>
                <option value="">Select Municipality</option>
                <?php foreach ($municipalities_list as $m): ?>
                  <option value="<?= $m['id'] ?>"><?= htmlspecialchars($m['name']) ?></option>
                <?php endforeach; ?>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-dark">Add Barangay</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Barangay Modal -->
  <div class="modal fade" id="editBarangayModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-geo-fill me-2"></i>Edit Barangay</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" action="/manage-locations.php">
          <div class="modal-body">
            <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrf) ?>">
            <input type="hidden" name="action" value="edit_barangay">
            <input type="hidden" name="id" id="editBarangayId">
            <div class="mb-3">
              <label class="form-label">Barangay Name</label>
              <input type="text" name="name" id="editBarangayName" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Municipality/City</label>
              <select name="municipality_id" id="editBarangayMunicipalityId" class="form-select" required>
                <option value="">Select Municipality</option>
                <?php foreach ($municipalities_list as $m): ?>
                  <option value="<?= $m['id'] ?>"><?= htmlspecialchars($m['name']) ?></option>
                <?php endforeach; ?>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-dark">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Municipality Form -->
  <form id="deleteMunicipalityForm" method="post" action="/manage-locations.php" style="display:none;">
    <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrf) ?>">
    <input type="hidden" name="action" value="delete_municipality">
    <input type="hidden" name="id" id="deleteMunicipalityId">
  </form>

  <!-- Delete Barangay Form -->
  <form id="deleteBarangayForm" method="post" action="/manage-locations.php" style="display:none;">
    <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrf) ?>">
    <input type="hidden" name="action" value="delete_barangay">
    <input type="hidden" name="id" id="deleteBarangayId">
  </form>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Municipality search filter
    document.getElementById('municipalitySearch')?.addEventListener('input', function(e) {
      const searchText = e.target.value.toLowerCase();
      const table = document.querySelector('.table');
      const rows = table?.querySelectorAll('tbody tr');
      const noResults = document.getElementById('municipalityNoResults');
      let visibleCount = 0;

      rows?.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchText)) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });

      if (noResults) {
        if (visibleCount === 0 && rows.length > 0) {
          noResults.classList.remove('d-none');
        } else {
          noResults.classList.add('d-none');
        }
      }
    });

    // Barangay search and filter
    const barangaySearch = document.getElementById('barangaySearch');
    const municipalityFilter = document.getElementById('municipalityFilter');

    function filterBarangays() {
      const searchText = barangaySearch?.value.toLowerCase() || '';
      const selectedMunicipality = municipalityFilter?.value.toLowerCase() || '';
      const rows = document.querySelectorAll('#barangayTableBody tr');
      const noResults = document.getElementById('barangayNoResults');
      let visibleCount = 0;

      rows.forEach(row => {
        const barangayName = row.dataset.barangay?.toLowerCase() || '';
        const municipalityName = row.dataset.municipality?.toLowerCase() || '';
        
        const matchesSearch = barangayName.includes(searchText);
        const matchesMunicipality = !selectedMunicipality || municipalityName === selectedMunicipality;

        if (matchesSearch && matchesMunicipality) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });

      if (noResults) {
        if (visibleCount === 0 && rows.length > 0) {
          noResults.classList.remove('d-none');
        } else {
          noResults.classList.add('d-none');
        }
      }
    }

    barangaySearch?.addEventListener('input', filterBarangays);
    municipalityFilter?.addEventListener('change', filterBarangays);

    function editMunicipality(id, name, province) {
      document.getElementById('editMunicipalityId').value = id;
      document.getElementById('editMunicipalityName').value = name;
      document.getElementById('editMunicipalityProvince').value = province;
      new bootstrap.Modal(document.getElementById('editMunicipalityModal')).show();
    }

    function deleteMunicipality(id, name) {
      if (confirm(`Are you sure you want to delete ${name}? This will fail if there are barangays assigned to it.`)) {
        document.getElementById('deleteMunicipalityId').value = id;
        document.getElementById('deleteMunicipalityForm').submit();
      }
    }

    function editBarangay(id, name, municipalityId) {
      document.getElementById('editBarangayId').value = id;
      document.getElementById('editBarangayName').value = name;
      document.getElementById('editBarangayMunicipalityId').value = municipalityId;
      new bootstrap.Modal(document.getElementById('editBarangayModal')).show();
    }

    function deleteBarangay(id, name) {
      if (confirm(`Are you sure you want to delete Barangay ${name}? This will fail if there are users assigned to it.`)) {
        document.getElementById('deleteBarangayId').value = id;
        document.getElementById('deleteBarangayForm').submit();
      }
    }
  </script>
</body>
</html>
